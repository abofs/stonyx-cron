# stonyx-cron

## TODO: Current version is mostly auto-generated by Windsurf. Expand on the details

A lightweight, high-performance job scheduler for Node.js applications.  
It allows you to register recurring jobs with second-level precision, without relying on external cron daemons or busy polling.

The module uses a **priority queue (min-heap)** internally to efficiently manage scheduled jobs. This means:
- ⚡ **Low CPU usage** (no constant polling)
- 📈 **Scales to thousands of jobs**
- ⏱ **Precise execution timing**
- 🔄 **Automatic rescheduling** after each run

---

## Installation

This is a stonyx module, and it depends on (`stonyx`, `@stonyx/utils`).  
Import it where needed:

```js
import Cron from '@stonyx/cron';
```

---

## API

### `new Cron()`
Creates or returns the singleton instance of the Cron scheduler.  
Only one instance will exist across your application.

---

### `register(key, callback, interval, runOnInit = false)`
Registers a new recurring job.

- **key**: `string` — Unique identifier for the job  
- **callback**: `function` — Function to execute when the job runs (can be `async`)  
- **interval**: `number|string` — Interval in seconds between executions  
- **runOnInit**: `boolean` (optional) — If `true`, runs the job immediately once on registration  

```js
const cron = new Cron();

cron.register(
  'sayHello',
  () => console.log('Hello world!'),
  10,        // every 10 seconds
  true       // run immediately
);
```

---

### `unregister(key)`
Removes a previously registered job.

```js
cron.unregister('sayHello');
```

---

### `log(text, key?)`
Internal logging helper. Uses `stonyx/log` with the `cron` type.  
Only logs if `config.cron.log` is `true`.

```js
cron.log('Custom log message', 'job1');
```

---

### Internal Methods
- **`setNextTrigger(job)`** — Computes the next execution timestamp for a job.  
- **`scheduleNextRun()`** — Determines when the next job is due and sets a timer.  
- **`runDueJobs()`** — Executes all jobs that are due at the current time.  

---

## Example Usage

```js
import Cron from './cron/Cron.js';

const cron = new Cron();

// A simple job that runs every 5 seconds
cron.register('heartbeat', () => {
  console.log(`[${new Date().toISOString()}] heartbeat`);
}, 5);

// A job that fetches data every minute, runs immediately on startup
cron.register(
  'fetchData',
  async () => {
    const result = await fetch('https://api.example.com/data');
    console.log('Fetched data:', await result.json());
  },
  60,
  true
);

// Remove a job dynamically
setTimeout(() => {
  cron.unregister('heartbeat');
  console.log('Heartbeat job stopped.');
}, 20000);
```

---

## Performance Notes

Unlike naive schedulers that constantly poll (`while(true)` + `sleep`), this implementation:

- Uses a **min-heap** (`MinHeap.js`) to always know the next job due in `O(1)`.  
- Schedules execution with `setTimeout`, only waking the event loop when needed.  
- Reschedules jobs in `O(log n)` time, even with thousands of active jobs.  

This makes it suitable for high-throughput Node.js services.

---

## Error Handling

If a job throws or rejects, the error is caught and logged via `stonyx/log.error`, without affecting the scheduler:

```txt
Cron job "jobName" failed: Error: boom
```

The job will still be rescheduled and run on its next interval.

---

## Testing

Unit tests are provided for both **Cron** and **MinHeap**, using **QUnit** + **Sinon**:

- `tests/unit/minheap.test.js` — validates heap ordering, push/pop/remove behavior  
- `tests/unit/cron.test.js` — validates registration, scheduling, rescheduling, logging, and error handling  

Run tests with:

```bash
npx qunit "tests/**/*.test.js"
```

---

## License

Apache — do what you want, just keep attribution.